# Сервис синхронизации тарифов Wildberries

Приложение регулярно запрашивает тарифы `https://common-api.wildberries.ru/api/v1/tariffs/box`, сохраняет их в PostgreSQL по дням и синхронизирует актуальные коэффициенты в указанные Google Sheets.

## Возможности
- **Ежечасное обновление тарифов.** Сервис обращается к API Wildberries, сохраняет срез ответа за текущий день и заменяет данные при повторном запуске в тот же день.
- **Поставка данных в Google Sheets.** После успешной загрузки тарифов и по отдельному расписанию актуальные коэффициенты выгружаются на лист `stocks_coefs` (настраивается).
- **Хранение истории.** Для каждого дня сохраняется JSON снапшот ответа WB, доступный для повторного анализа.

## Подготовка окружения
1. Скопируйте файл переменных окружения и заполните значения:
   ```bash
   cp example.env .env
   ```
   Обязательные переменные:
   - `POSTGRES_HOST` – адрес PostgreSQL (по умолчанию `postgres` при запуске через `docker compose`).
   - `WB_API_TOKEN` – токен доступа WB (формат `Authorization` заголовка).
   - `GOOGLE_SERVICE_ACCOUNT_EMAIL`, `GOOGLE_PRIVATE_KEY` – данные сервисного аккаунта Google (ключ можно оставить в формате с `\n`).
   - `WB_FETCH_MINUTE_OFFSET` – минута часа для запроса тарифов (по умолчанию `0`).
   - `GOOGLE_SHEETS_UPDATE_MINUTE_OFFSET` – минута часа (0–59) для обновления таблиц (по умолчанию `5`).
   - `GOOGLE_SHEETS_TARGET_SHEET` – имя листа в таблицах (по умолчанию `stocks_coefs`).

2. Создайте сервисный аккаунт Google и сохраните файл с ключом, например `google-credentials.json`. В репозитории лежит пример: `google-credentials.example.json`.
   - Включите Google Sheets API для проекта в [Google Cloud Console](https://console.cloud.google.com/apis/library/sheets.googleapis.com).
   - Скачайте JSON-ключ сервисного аккаунта и скопируйте значения `client_email` и `private_key` в переменные окружения `GOOGLE_SERVICE_ACCOUNT_EMAIL` и `GOOGLE_PRIVATE_KEY`.
   - Обязательно поделитесь каждой рабочей таблицей с адресом сервисного аккаунта с правами «Редактор», иначе обновление закончится ошибкой 403.

3. Добавьте файл с ключом в контейнер (например, через монтирование) и убедитесь, что значения переменных окружения совпадают с данными сервисного аккаунта. Если используете ключ напрямую из JSON, сохраните его рядом с `.env` и добавьте примонтированный путь в `docker compose`.

4. Укажите идентификаторы Google Sheets в таблице `spreadsheets`. После старта контейнера можно выполнить команду:
   ```bash
   docker compose exec app node dist/utils/knex.js seed run
   ```
   или использовать `npm run knex:dev` локально. Таблица может содержать любое количество строк с `spreadsheet_id`.

## Запуск
Полный запуск приложения в контейнерах:
```bash
docker compose up --build
```
Команда поднимет PostgreSQL, соберёт приложение, выполнит миграции и сиды, затем запустит планировщик задач.

Для разработки вне Docker:
```bash
npm install
npm run dev
```
Перед запуском убедитесь, что PostgreSQL доступна и переменные окружения заданы.

## Работа планировщика
- При старте выполняется первичный сбор тарифов и синхронизация таблиц.
- Далее сбор тарифов повторяется каждый час в минуту `WB_FETCH_MINUTE_OFFSET`.
- Обновление Google Sheets происходит каждый час в минуту `GOOGLE_SHEETS_UPDATE_MINUTE_OFFSET` и также после каждого успешного сбора.
- Данные в листе сортируются по коэффициенту, строка содержит коэффициент, данные склада и путь до объекта в ответе.

## Структура БД
- `spreadsheets(spreadsheet_id)` – перечень Google Sheets, которые требуется обновлять.
- `tariff_snapshots(id, tariff_date, payload, updated_at)` – ежедневные снапшоты ответа Wildberries. При повторном сборе в тот же день запись обновляется.

## Проверка работы
1. Запустите проект:
   ```bash
   docker compose up --build
   ```
2. Отслеживайте логи приложения и дождитесь записи вида `Stored tariff snapshot`:
   ```bash
   docker compose logs -f app
   ```
3. Убедитесь, что в базе появился снапшот за текущий день:
   ```bash
   docker compose exec postgres psql -U postgres -d postgres \
     -c "SELECT tariff_date, updated_at FROM tariff_snapshots ORDER BY updated_at DESC LIMIT 5;"
   ```
4. Проверьте выбранные Google Sheets – лист `stocks_coefs` должен содержать обновлённые коэффициенты в порядке возрастания. Если данные не появляются, убедитесь, что таблица расшарена на сервисный аккаунт и его ключ корректно подставлен в переменные окружения.

## Дополнительные команды
- Управление миграциями/сидами локально: `npm run knex:dev <command>`.
- Сборка TypeScript: `npm run build`.
- Запуск приложения из собранного кода: `npm start`.

